<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('新增报价单')" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">


        <div class="form-horizontal m form-group">
            <label class="col-sm-3 control-label">系数设置：</label>
            <div class='col-sm-1'>
                <input class='form-control' type='text' id="productCoefficientAll" onblur="setCoefficientAll(1)"  placeholder='产品系数' onkeyup="AmountKeyUp(this)"/>
            </div>
            <div class='col-sm-1'>
                <input class='form-control' type='text' id="actuatorCoefficientAll" onblur="setCoefficientAll(2)"  placeholder='执行器系数' onkeyup="AmountKeyUp(this)"/>
            </div>
            <div class='col-sm-1'>
                <input class='form-control' type='text' id="productRef1CoefficientAll" onblur="setCoefficientAll(3)"  placeholder='法兰系数' onkeyup="AmountKeyUp(this)"/>
            </div>
            <div class='col-sm-1'>
                <input class='form-control' type='text' id="productRef2CoefficientAll" onblur="setCoefficientAll(4)" placeholder='螺栓系数' onkeyup="AmountKeyUp(this)"/>
            </div>
            <div class='col-sm-2'>
                <a class="btn btn-success btn-sm" onclick="insertRow()">
                    <i class="fa fa-plus"></i> 新增
                </a>
                <a class="btn btn-success btn-sm" onclick="uploadFile()">
                    <i class="fa fa-plus"></i> 智能增加
                </a>
            </div>

        </div>

        <div class="form-horizontal" id="productDiv">
            <div class="row">
                <div class="col-sm-12 select-table table-striped">
                    <table id="bootstrap-table" data-use-row-attr-func="true"
                           data-reorderable-rows="true"></table>
                </div>
            </div>
        </div>

        <form class="form-horizontal m" id="form-quotation-add">

            <div class="form-group">
                <label class="col-sm-3 control-label">客户名称：</label>
                <div class="col-sm-3">
                    <input name="customerName" id="customerName" class="form-control" type="text" readonly onclick="selectCustomer()" required>
                    <input name="string2" id="string2" class="form-control" type="hidden" >
                </div>
                <label class="col-sm-1 control-label">报价单号：</label>
                <div class="col-sm-4">
                    <input name="string1" id="string1" class="form-control" type="text" readonly th:value="${bh}" required>
                </div>
            </div>

            <!--
            <div class="form-group">
                <label class="col-sm-3 control-label">选择产品：</label>
                <div class="col-sm-6">
                    <input name="productIds" id="productIds" class="form-control" type="hidden" >
                    <input name="productNames" id="productNames" class="form-control" type="text" readonly onclick="selectProduct(0)" required>
                </div>

                <div class="col-sm-3">
                    <a class="btn btn-success btn-sm" onclick="selectProduct(1)" >
                        <i class="fa fa"></i> 追加
                        <input type="hidden" id="productOperationType" name="productOperationType" value="0">
                    </a>
                </div>
            </div>-->





            <div class="form-group">    
                <label class="col-sm-3 control-label">特殊费用：</label>
                <div class="col-sm-3">
                    <input name="specialExpenses" id="specialExpenses" onblur="calculateTotalPrice()" onkeyup="AmountKeyUp(this)" class="form-control" type="text">
                </div>
                <label class="col-sm-1 control-label">费用说明：</label>
                <div class="col-sm-4">
                    <input name="string4" id="string4" class="form-control" type="text" placeholder="特殊费用说明">
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">付款方式：</label>
                <div class="col-sm-2">
                    <select name="paymentMethod" id="paymentMethod" class="form-control"  th:with="type=${@dict.getType('payment_method')}">
                        <option th:each="dict : ${type}" th:text="${dict.dictLabel}"  th:value="${dict.dictValue}"></option>
                    </select>
                </div>
                <div class="col-sm-2 form-inline" id="string6Div" >
                    <input name="string6" id="string6" class="form-control" type="text" placeholder="付款备注">
                </div>
                <label class="col-sm-1 control-label">运费价格：</label>
                <div class="col-sm-2 form-inline">
                    <input name="freight" class="form-control full-width" type="text" onkeyup="AmountKeyUp(this)" placeholder="运费价格">
                </div>

            </div>

            <div class="form-group">    
                <label class="col-sm-3 control-label">供货周期：</label>
                <div class="col-sm-3">
                    <input name="leadTime" class="form-control" type="text">
                </div>
                <label class="col-sm-1 control-label" >报备项目：</label>
                <div class="col-sm-4">
                    <input name="reportProject" class="form-control" type="text" value="非项目">
                </div>

            </div>


            <!--
            <div class="form-group">
                <label class="col-sm-3 control-label">项目名称：</label>
                <div class="col-sm-8">
                    <input name="string5" class="form-control" type="text" >
                </div>
            </div>-->

            <div class="form-group">
                <label class="col-sm-3 control-label">报价备注：</label>
                <div class="col-sm-8">
                    <input name="remark" class="form-control" type="text" >
                </div>
            </div>

            <div class="form-group" >
                <label class="col-sm-3 control-label">产品金额：</label>
                <div class="col-sm-2">
                    <input name="productTotalPrice" id="productTotalPrice" class="form-control" type="text" readonly>
                </div>

                <label class="col-sm-1 control-label">合同金额：</label>
                <div class="col-sm-2">
                    <input name="totalPrice" id="totalPrice" class="form-control" type="text" readonly>
                </div>
            </div>
            <!-- 选择产品传参 -->
            <input type="hidden" id="productsJsonParamter" value=""/>
            <!-- 选择法兰传参 -->
            <input type="hidden" id="ref1JsonParamter" value=""/>
            <!-- 选择螺栓传参 -->
            <input type="hidden" id="ref2JsonParamter" value=""/>
            <!-- 选择执行器传参 -->
            <input type="hidden" id="actuatorJsonParamter" value=""/>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-editable-css" />
    <th:block th:include="include :: bootstrap-table-reorder-js" />
    <th:block th:include="include :: bootstrap-table-editable-js" />
    <script type="text/javascript">

        var prefix = ctx + "fmis/quotation"

        var icon = "<i class='fa fa-times-circle'></i> ";
        $("#form-quotation-add").validate({
            onkeyup: false,
            rules: {
                customerName:{
                    required: true,
                    remote: {
                        url: prefix + "/checkCustomer",
                        type: "post",
                        dataType: "json",
                        async: false,
                        data: {
                            string2 : function() {
                                return $.common.trim($("#string2").val());
                            },
                            string3 : 0
                        },
                        dataFilter: function(data, type) {
                            var validateUnique = $.validate.unique(data);
                            console.log("data=" + data);
                            console.log("validateUnique=" + validateUnique);
                            return validateUnique;
                        }
                    }
                },
            },
            messages: {
                "customerName": {
                    required: icon + "请选择客户",
                    remote: icon + "客户重复"
                }
            },
            focusCleanup: true
        });

        function submitHandler() {
            var vali = $.validate.form();
            console.log("vali=" + vali);
            if (vali) {
                var dataObj = $('#form-quotation-add').serializeArray();
                //计算是否正常
                //特殊费用
                var specialExpenses = $("#specialExpenses").val();
                if (specialExpenses != null && specialExpenses.length > 0) {
                    dataObj.push({"normalFlag": "1"});
                } else {
                    dataObj.push({"normalFlag": "0"});
                }

                var data = $.btTable.bootstrapTable('getData');
                var productTotalPrice = 0;
                var productArray = new Array();
                for (var i = 0; i < data.length; i++) {
                    var rowData = data[i];
                    var productObj = new Object();
                    productObj["productId"] = rowData["productId"];
                    productObj["productRef1Id"] = rowData["productRef1Id"];
                    productObj["productRef1Num"] = rowData["productRef1Num"];
                    productObj["productRef2Id"] = rowData["productRef2Id"];
                    productObj["productRef2Num"] = rowData["productRef2Num"];
                    productObj["actuatorId"] = rowData["actuatorId"];

                    productObj["productNum"] = rowData["productNum"];
                    productObj["productCoefficient"] = rowData["productCoefficient"];
                    productObj["productRef1Coefficient"] = rowData["productRef1Coefficient"];
                    productObj["productRef2Coefficient"] = rowData["productRef2Coefficient"];
                    productObj["actuatorNum"] = rowData["actuatorNum"];
                    productObj["actuatorCoefficient"] = rowData["actuatorCoefficient"];
                    productObj["string4"] = rowData["productRemark"];
                    productArray.push(productObj);
                }
                dataObj.push({"name": "string10", "value": JSON.stringify(productArray)});
                var totalPrice = $("#totalPrice").val();
                dataObj.push({"name": "string9", "value": totalPrice});
                $.operate.save(prefix + "/add", dataObj);
            }
        }

        function selectCustomer() {
            var widthNum = this.innerWidth - 50;
            var heigthNum = this.innerHeight - 50;
            var url = prefix + "/selectCustomer";
            $.modal.open("关联客户", url,widthNum, heigthNum);
        }

        function isEmpty(v) {
            return $.common.isEmpty(v);
        }

        function setCoefficientAll (type) {
            //type 1=产品 2=执行器 3=法兰 4=螺栓
            var productArray = new Array();
            var productCoefficientAll = $("#productCoefficientAll").val();
            var actuatorCoefficientAll = $("#actuatorCoefficientAll").val();
            var productRef1CoefficientAll = $("#productRef1CoefficientAll").val();
            var productRef2CoefficientAll = $("#productRef2CoefficientAll").val();

            var data = $.btTable.bootstrapTable('getData');
            var productArray = new Array();
            if (data == null || data.length == 0) {
                return;
            }
            for (var i = 0; i < data.length; i++) {
                var rowData = data[i];
                var productObj = new Object();
                var productId =  rowData["productId"];
                if (type == 1 && !isEmpty(productCoefficientAll)) {
                    var updateObj = {
                        index : rowData.rowId,
                        field : "productCoefficient",
                        value : productCoefficientAll
                    };
                    $.btTable.bootstrapTable("updateCell",updateObj);
                } else if (type == 2 && !isEmpty(actuatorCoefficientAll)) {
                    var updateObj = {
                        index : rowData.rowId,
                        field : "actuatorCoefficient",
                        value : actuatorCoefficientAll
                    };
                    $.btTable.bootstrapTable("updateCell",updateObj);
                } else if (type == 3 && !isEmpty(productRef1CoefficientAll)) {
                    var updateObj = {
                        index : rowData.rowId,
                        field : "productRef1Coefficient",
                        value : productRef1CoefficientAll
                    };
                    $.btTable.bootstrapTable("updateCell",updateObj);
                } else if (type == 4 && !isEmpty(productRef2CoefficientAll)) {
                    var updateObj = {
                        index : rowData.rowId,
                        field : "productRef2Coefficient",
                        value : productRef2CoefficientAll
                    };
                    $.btTable.bootstrapTable("updateCell",updateObj);
                }
            }
            calculateTotalPrice();

        }

        function FloatAdd(arg1,arg2){
            var r1,r2,m;
            try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}
            try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}
            m=Math.pow(10,Math.max(r1,r2));
            return (arg1*m+arg2*m)/m;
        }

        $(function() {
            var options = {
                showSearch: false,
                showRefresh: false,
                pagination: false,
                showColumns: false,
                showToggle: false,
                useRowAttrFunc: true,
                uniqueId: "productId",
                onEditableSave: onEditableSave,
                onClickCell: onClickCell,
                onReorderRow: onReorderRow,
                columns: [{
                    checkbox: true
                },
                    {field : 'rowId',title : '序号',visible: true,formatter:function(value,row,index){row.rowId = index;return index+1;}},
                    {field : 'productId',title : '产品ID',visible: false},
                    {field : 'productName',title : '名称',editable: false},
                    {field : 'model',title : '型号',editable: false},
                    {field : 'specifications',title : '规格',editable: false},
                    {field : 'nominalPressure',title : '压力',editable: false},
                    {field : 'valvebodyMaterial',title : '阀体',editable: false},
                    {field : 'valveElement',title : '阀芯',editable: false},
                    {field : 'sealingMaterial',title : '密封材质',editable: false},
                    {field : 'driveForm',title : '驱动形式',editable: false},
                    {field : 'connectionType',title : '连接方式',editable: false},
                    {field : 'productNum',title : '数量',editable: {type: 'text',validate: function(v){ return numberValidate(v)}}},
                    {field : 'productPrice',title : '单价',editable: false},
                    {field : 'productCoefficient',title : '系数',editable: {type: 'text',validate: function(v){ return numberValidate(v)}}},


                    {field : 'actuatorId',title : 'actuatorId',visible: false},
                    {field : 'actuatorName',title : '执行器名称',editable: true},
                    {field : 'actuatorPrice',title : '执行器价格',editable: false},
                    {field : 'actuatorNum',title : '执行器数量',editable: {type: 'text',validate: function(v){ return numberValidate(v)}}},
                    {field : 'actuatorCoefficient',title : '执行器系数',editable: {type: 'text',validate: function(v){ return numberValidate(v)}}},

                    {field : 'productRef1Id',title : 'ref1Id',visible: false},
                    {field : 'ref1Name',title : '法兰名称',editable: false},

                    {field : 'ref1Price',title : '法兰价格',editable: false},
                    {field : 'productRef1Num',title : '法兰数量',editable: {type: 'text',validate: function(v){ return numberValidate(v)}}},
                    {field : 'productRef1Coefficient',title : '法兰系数',editable: {type: 'text',validate: function(v){ return numberValidate(v)}}},

                    {field : 'productRef2Id',title : 'ref2Id',visible: false},
                    {field : 'ref2Name',title : '螺栓名称',editable: true},
                    {field : 'ref2Price',title : '螺栓价格',editable: false},
                    {field : 'productRef2Num',title : '螺栓数量',editable: {type: 'text',validate: function(v){ return numberValidate(v)}}},
                    {field : 'productRef2Coefficient',title : '螺栓系数',editable: {type: 'text',validate: function(v){ return numberValidate(v)}}},


                    {field : 'productRemark',title : '备注',editable: {type: 'text',emptytext: '空'}},
                    {field : 'totalPrice',title : '总价',editable: false},
                    {
                        title: '操作',
                        align: 'center',
                        formatter: function(value, row, index) {
                            var actions = [];
                            var productId = row["productId"]
                            actions.push('<a class="btn btn-danger btn-xs" href="#" onclick="removeProduct(' + productId + ')"><i class="fa fa-remove"></i>删除</a>');
                            return actions.join('');
                        }
                    }]
            };
            $.table.init(options);


            //paymentMethod 付款方式中，选择“其它”付款方式时，没有内容输入框。

        });
        function removeProduct(uid) {
            $.btTable.bootstrapTable('removeByUniqueId', uid);
            calculateTotalPrice();
        }
        function onEditableSave (field, row, oldValue, $el) {
            //alert("字段名：" + field + "，当前值：" + row[field]  + "，旧值：" + oldValue);
            if (field == "productNum" || field == "productCoefficient" || field == "productRef1Num"|| field == "productRef1Coefficient"
                || field == "productRef2Num"|| field == "productRef2Coefficient" || field == "actuatorNum" || field == "actuatorCoefficient") {
                calculateTotalPrice();
            }
        }

        function calculatePrice (row) {
            var productNum = row["productNum"];
            productNum = isEmpty(productNum) == true ? 0 : parseFloat(productNum);

            var productCoefficient = row["productCoefficient"];
            productCoefficient = isEmpty(productCoefficient) == true ? 0 : parseFloat(productCoefficient);

            var productPrice = row["productPrice"];
            productPrice = isEmpty(productPrice) == true ? 0 : parseFloat(productPrice);

            //法兰
            var productRef1Num = row["productRef1Num"];
            productRef1Num = isEmpty(productRef1Num) == true ? 0 : parseFloat(productRef1Num);
            var productRef1Coefficient = row["productRef1Coefficient"];
            productRef1Coefficient = isEmpty(productRef1Coefficient) == true ? 0 : parseFloat(productRef1Coefficient);
            var productRef1Price = row["ref1Price"];
            productRef1Price = isEmpty(productRef1Price) == true ? 0 : parseFloat(productRef1Price);

            //螺栓
            var productRef2Num = row["productRef2Num"];
            productRef2Num = isEmpty(productRef2Num) == true ? 0 : productRef2Num;
            var productRef2Coefficient = row["productRef2Coefficient"];
            productRef2Coefficient = isEmpty(productRef2Coefficient) == true ? 0 : parseFloat(productRef2Coefficient);
            var productRef2Price = row["ref2Price"];
            productRef2Price = isEmpty(productRef2Price) == true ? 0 : parseFloat(productRef2Price);
            //执行器
            var actuatorNum = row["actuatorNum"];
            actuatorNum = isEmpty(actuatorNum) == true ? 0 : actuatorNum;
            var actuatorCoefficient = row["actuatorCoefficient"];
            actuatorCoefficient = isEmpty(actuatorCoefficient) == true ? 0 : parseFloat(actuatorCoefficient);
            var actuatorPrice = row["actuatorPrice"];
            actuatorPrice = isEmpty(actuatorPrice) == true ? 0 : parseFloat(actuatorPrice);
            var productSum = parseFloat(productNum * productPrice * productCoefficient).toFixed(4);
            var productRef1Sum = parseFloat(productRef1Num * productRef1Price * productRef1Coefficient).toFixed(4);
            var productRef2Sum = parseFloat(productRef2Num * productRef2Price * productRef2Coefficient).toFixed(4);
            var actuatorSum = parseFloat(actuatorNum * actuatorCoefficient * actuatorPrice).toFixed(4);
            var totalSum = parseFloat(parseFloat(productSum) + parseFloat(productRef1Sum) + parseFloat(productRef2Sum) + parseFloat(actuatorSum)).toFixed(4);
            var updateObj = {
                index : row.rowId,
                field : "totalPrice",
                value : totalSum
            };
            $.btTable.bootstrapTable("updateCell",updateObj);
            //$("#totalSum_" + productId).val(totalSum);
            return totalSum;
        }

        function calculateTotalPrice () {
            var data = $.btTable.bootstrapTable('getData');
            var productTotalPrice = 0;
            for (var i = 0; i < data.length; i++) {
                var rowData = data[i];
                var price = calculatePrice(rowData);
                productTotalPrice = FloatAdd(productTotalPrice,price).toFixed(4);
            }
            var specialExpenses = $("#specialExpenses").val();
            if (isEmpty(specialExpenses)) {
                specialExpenses = 0;
            }
            $("#productTotalPrice").val(parseFloat(productTotalPrice).toFixed(4));
            var totalPrice = parseFloat(productTotalPrice) + parseFloat(specialExpenses);
            $("#totalPrice").val(parseFloat(totalPrice).toFixed(4));
        }

        function numberValidate(value) {
            if (isNaN(value)) {
                return "必须是数字！";
            }
        }


        function onReorderRow(data) {
            for (var i = 0; i < data.length; i++) {
                //$("#columns_sort_" + data[i].columnId).val(i+1);
            }
        }
        /* 查询表格所有数据值 */
        function getData(){
            var data = $.btTable.bootstrapTable('getData');
            alert(JSON.stringify(data))
        }
        function onClickCell(field, value, row, $element){
            var idx = $element.parent().data('index');
            console.log("row.index=" + idx + "--" + row.productId);
            var productId = row.productId;
            if (field == "ref1Name") {
                //选择法兰
                var widthNum = $("#form-quotation-add").width() - 50;
                var heigthNum = $("#form-quotation-add").height() + 250;
                var url = prefix + "/selectProductRef1?productId=" + productId;
                console.log("widthNum=" + widthNum + "---" + this.innerWidth);
                $.modal.open("关联产品配件法兰", url,widthNum, heigthNum,function (index, layero) {
                    var iframeWin = layero.find('iframe')[0];
                    iframeWin.contentWindow.submitHandler(index, layero);
                    //ref1JsonParamter
                    var ref1JsonParamter = $("#ref1JsonParamter").val();
                    setTableValueById(ref1JsonParamter,productId,idx);
                });
            } else if (field == "ref2Name") {
                //选择法兰
                var widthNum = $("#form-quotation-add").width() - 50;
                var heigthNum = $("#form-quotation-add").height() + 250;
                var url = prefix + "/selectProductRef2?productId=" + productId;
                console.log("widthNum=" + widthNum + "---" + this.innerWidth);
                $.modal.open("关联产品配件螺栓", url,widthNum, heigthNum,function (index, layero) {
                    var iframeWin = layero.find('iframe')[0];
                    iframeWin.contentWindow.submitHandler(index, layero);
                    var ref2JsonParamter = $("#ref2JsonParamter").val();
                    setTableValueById(ref2JsonParamter,productId,idx);
                });
            } else if (field == "actuatorName") {
                var widthNum = $("#form-quotation-add").width() - 50;
                var heigthNum = $("#form-quotation-add").height() + 250;
                var url = prefix + "/selectActuator?productId=" + productId;
                console.log("widthNum=" + widthNum + "---" + this.innerWidth);
                $.modal.open("关联执行器", url,widthNum, heigthNum,function (index, layero) {
                    var iframeWin = layero.find('iframe')[0];
                    iframeWin.contentWindow.submitHandler(index, layero);
                    var actuatorJsonParamter = $("#actuatorJsonParamter").val();
                    setTableValueById(actuatorJsonParamter,productId,idx);
                });
            }
        }

        //根据表ID修改某一列的值
        function setTableValueById (jsonValue,id,idx) {
            var jsonObj = JSON.parse(jsonValue);
            for (key in jsonObj) {
                var updateObj = {
                    index : idx,
                    field : key,
                    value : jsonObj[key]
                };
                $.btTable.bootstrapTable("updateCell",updateObj);
            }
        }



        /* 新增表格行 */
        function insertRow(){
            var url = prefix + "/selectProduct";
            var widthNum = this.innerWidth - 50;
            var heigthNum = this.innerHeight - 50;

            $.modal.open("关联产品", url,widthNum, heigthNum,function (index, layero) {
                var iframeWin = layero.find('iframe')[0];
                iframeWin.contentWindow.submitHandler(index, layero);
                appendTable();

            });
        }
        /* 查询表格选择行数据值 */
        function getSelections(){
            var data = $.btTable.bootstrapTable('getSelections');
        }

        function appendTable () {
            var productsJsonParamter = $("#productsJsonParamter").val();
            console.log("productsJsonParamter=" + productsJsonParamter);
            var productsJsonArray = JSON.parse(productsJsonParamter);
            var tableData = $.btTable.bootstrapTable('getData');
            var tableMap = new Map();
            if (tableData != null) {
                for (var i = 0; i < tableData.length; i++) {
                    var rowData = tableData[i];
                    tableMap.set(rowData["productId"],rowData["productId"]);
                }
            }
            for (var i = 0; i < productsJsonArray.length; i++) {
                var productJson = productsJsonArray[i];
                if (!tableMap.has(productJson["productId"])) {
                    $.btTable.bootstrapTable('append', productJson);
                }
            }

            calculateTotalPrice();
        }

        function uploadFile () {
            var url = prefix + "/upload";
            var widthNum = this.innerWidth - 50;
            var heigthNum = this.innerHeight - 50;
            $.modal.open("关联产品", url,widthNum, heigthNum,function (index, layero) {
                var iframeWin = layero.find('iframe')[0];
                iframeWin.contentWindow.submitHandler(index, layero);
                appendTable();
                calculateTotalPrice();
            });
        }



    </script>
</body>
</html>