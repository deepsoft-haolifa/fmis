<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.fmis.quotation.mapper.BizQuotationMapper">
    
    <resultMap type="BizQuotation" id="BizQuotationResult">
        <result property="quotationId"    column="quotation_id"    />
        <result property="productId"    column="product_id"    />
        <result property="productRef1Id"    column="product_ref1_id"    />
        <result property="productRef1Num"    column="product_ref1_num"    />
        <result property="productRef2Id"    column="product_ref2_id"    />
        <result property="productRef2Num"    column="product_ref2_num"    />
        <result property="actuatorId"    column="actuator_id"    />
        <result property="specialExpenses"    column="special_expenses"    />
        <result property="paymentMethod"    column="payment_method"    />
        <result property="freight"    column="freight"    />
        <result property="leadTime"    column="lead_time"    />
        <result property="reportProject"    column="report_project"    />

        <result property="normalFlag"    column="normal_flag"    />

        <result property="flowStatus"    column="flow_status"    />

        <result property="remark"    column="remark"    />
        <result property="string1"    column="string1"    />
        <result property="string2"    column="string2"    />
        <result property="string3"    column="string3"    />
        <result property="string4"    column="string4"    />
        <result property="string5"    column="string5"    />
        <result property="string6"    column="string6"    />
        <result property="string7"    column="string7"    />
        <result property="string8"    column="string8"    />
        <result property="string9"    column="string9"    />
        <result property="string10"    column="string10"    />
        <result property="status"    column="status"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
    </resultMap>

    <sql id="selectBizQuotationVo">
        select quotation_id, product_id, product_ref1_id, product_ref1_num, product_ref2_id, product_ref2_num, actuator_id, special_expenses, payment_method, freight, lead_time, report_project, normal_flag, flow_status, remark, string1, string2, string3, string4, string5, string6, string7, string8, string9, string10, status, del_flag, create_by, create_time, update_by, update_time from biz_quotation
    </sql>

    <select id="selectBizQuotationList" parameterType="BizQuotation" resultMap="BizQuotationResult">
        <include refid="selectBizQuotationVo"/>
        <where>  
            <if test="freight != null "> and freight = #{freight}</if>
            <if test="string1 != null "> and string1 = #{string1}</if>
        </where>
    </select>

    <!-- 流程列表 -->
    <sql id="selectBizQuotationFlowVo">
        select q.quotation_id,q.product_id,q.product_ref1_id,q.product_ref1_num,q.product_ref2_id,q.product_ref2_num,q.actuator_id,
          q.special_expenses,q.payment_method,q.freight,q.lead_time,q.report_project,q.normal_flag,q.flow_status,q.remark,q.string1,
          q.string2,q.string3,q.string4,q.string5,q.string6,q.string7,q.string8,q.string9,q.string10,q.status,q.del_flag,u.user_name as create_by,
          q.create_time,q.update_by,q.update_time,
          p.name as productName,pr1.name as productRef1Name,pr2.name as productRef2Name,ac.name as actuatorName,
          ct.name as customerName
        from biz_quotation q
        left join biz_product p on q.product_id=p.product_id
        left join biz_product_ref pr1 on pr1.product_ref_id=q.product_ref1_id
        left join biz_product_ref pr2 on pr2.product_ref_id=q.product_ref2_id
        left join biz_actuator ac on ac.actuator_id=q.actuator_id
        left join sys_user u on q.create_by=u.user_id
        left join sys_dept dt on u.dept_id=dt.dept_id
        left join biz_customer ct on ct.customer_id=q.string2
    </sql>
<!-- 流程状态0=未上报  1=销售员上报  2=销售经理同意 -2=销售经理不同意 3=区域经理同意 -3=区域经理不同意 4=副总同意 -4=副总不同意 5=老总同意 -5=老总不同意 -->
    <select id="selectBizQuotationFlowList" parameterType="BizQuotation" resultMap="BizQuotationResult">
        <include refid="selectBizQuotationFlowVo"/>
        <where>
            <if test="quotationId != null"> and q.quotation_id = #{quotationId}</if>
            <!-- string2作为角色参数 1=销售 2=销售经理 3=区域经理 4=副总 5=老总-->
            <if test="string2 == 1 ">  ${params.dataScope}</if>
            <!-- 销售经理 查看已上报的 -->
            <if test="string2 == 2 ">
                <if test="string6 == 0 ">
                    q.flow_status in ('1','2','-2','3','-3','-4','-5')
                </if>
                <if test="string6 == 1 ">
                    q.flow_status in ('1')
                </if>
                <if test="string6 == 2 ">
                    q.flow_status in ('2','-2','3','-3','-4','-5')
                </if>
                ${params.dataScope}
            </if>
            <!-- 区域经理  查看 销售经理同意的  -->
            <if test="string2 == 3 ">
                <if test="string6 == 0 ">
                    q.flow_status in ('2','3','-3','4','-4','-5')
                </if>
                <if test="string6 == 1 ">
                    q.flow_status in ('2')
                </if>
                <if test="string6 == 2 ">
                    q.flow_status in ('3','-3','4','-4','-5')
                </if>
                ${params.dataScope}
            </if>
            <!-- 副总  查看 区域经理同意的  -->
            <if test="string2 == 4 ">
                <if test="string6 == 0 ">
                    q.flow_status in ('3','4','-4','-5')
                </if>
                <if test="string6 == 1 ">
                    q.flow_status in ('3')
                </if>
                <if test="string6 == 2 ">
                    q.flow_status in ('4','-4','-5')
                </if>

                ${params.dataScope}
            </if>
            <!-- 总经理  查看 副总同意的  -->
            <if test="string2 == 5 ">
                <if test="string6 == 0 ">
                    q.flow_status in ('4','5','-5')
                </if>
                <if test="string6 == 1 ">
                    q.flow_status in ('4')
                </if>
                <if test="string6 == 2 ">
                    q.flow_status in ('5','-5')
                </if>

                ${params.dataScope}

            </if>
        </where>
        order by q.create_time desc
    </select>
    
    <select id="selectBizQuotationById" parameterType="Long" resultMap="BizQuotationResult">
        <include refid="selectBizQuotationVo"/>
        where quotation_id = #{quotationId}
    </select>
        
    <insert id="insertBizQuotation" parameterType="BizQuotation" useGeneratedKeys="true" keyProperty="quotationId">
        insert into biz_quotation
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="productId != null ">product_id,</if>
            <if test="productRef1Id != null ">product_ref1_id,</if>
            <if test="productRef1Num != null  and productRef1Num != ''">product_ref1_num,</if>
            <if test="productRef2Id != null ">product_ref2_id,</if>
            <if test="productRef2Num != null  and productRef2Num != ''">product_ref2_num,</if>
            <if test="actuatorId != null ">actuator_id,</if>
            <if test="specialExpenses != null  and specialExpenses != ''">special_expenses,</if>
            <if test="paymentMethod != null  and paymentMethod != ''">payment_method,</if>
            <if test="freight != null ">freight,</if>
            <if test="leadTime != null  and leadTime != ''">lead_time,</if>
            <if test="reportProject != null  and reportProject != ''">report_project,</if>
            <if test="flowStatus != null  and flowStatus != ''">flow_status,</if>
            <if test="normalFlag != null  and normalFlag != ''">normal_flag,</if>
            <if test="remark != null  and remark != ''">remark,</if>
            <if test="string1 != null  and string1 != ''">string1,</if>
            <if test="string2 != null  and string2 != ''">string2,</if>
            <if test="string3 != null  and string3 != ''">string3,</if>
            <if test="string4 != null  and string4 != ''">string4,</if>
            <if test="string5 != null  and string5 != ''">string5,</if>
            <if test="string6 != null  and string6 != ''">string6,</if>
            <if test="string7 != null  and string7 != ''">string7,</if>
            <if test="string8 != null  and string8 != ''">string8,</if>
            <if test="string9 != null  and string9 != ''">string9,</if>
            <if test="string10 != null  and string10 != ''">string10,</if>
            <if test="status != null  and status != ''">status,</if>
            <if test="delFlag != null  and delFlag != ''">del_flag,</if>
            <if test="createBy != null  and createBy != ''">create_by,</if>
            <if test="createTime != null ">create_time,</if>
            <if test="updateBy != null  and updateBy != ''">update_by,</if>
            <if test="updateTime != null ">update_time,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="productId != null ">#{productId},</if>
            <if test="productRef1Id != null ">#{productRef1Id},</if>
            <if test="productRef1Num != null  and productRef1Num != ''">#{productRef1Num},</if>
            <if test="productRef2Id != null ">#{productRef2Id},</if>
            <if test="productRef2Num != null  and productRef2Num != ''">#{productRef2Num},</if>
            <if test="actuatorId != null ">#{actuatorId},</if>
            <if test="specialExpenses != null  and specialExpenses != ''">#{specialExpenses},</if>
            <if test="paymentMethod != null  and paymentMethod != ''">#{paymentMethod},</if>
            <if test="freight != null ">#{freight},</if>
            <if test="leadTime != null  and leadTime != ''">#{leadTime},</if>
            <if test="reportProject != null  and reportProject != ''">#{reportProject},</if>
            <if test="normalFlag != null  and normalFlag != ''">#{normalFlag},</if>
            <if test="flowStatus != null  and flowStatus != ''">#{flowStatus},</if>
            <if test="remark != null  and remark != ''">#{remark},</if>
            <if test="string1 != null  and string1 != ''">#{string1},</if>
            <if test="string2 != null  and string2 != ''">#{string2},</if>
            <if test="string3 != null  and string3 != ''">#{string3},</if>
            <if test="string4 != null  and string4 != ''">#{string4},</if>
            <if test="string5 != null  and string5 != ''">#{string5},</if>
            <if test="string6 != null  and string6 != ''">#{string6},</if>
            <if test="string7 != null  and string7 != ''">#{string7},</if>
            <if test="string8 != null  and string8 != ''">#{string8},</if>
            <if test="string9 != null  and string9 != ''">#{string9},</if>
            <if test="string10 != null  and string10 != ''">#{string10},</if>
            <if test="status != null  and status != ''">#{status},</if>
            <if test="delFlag != null  and delFlag != ''">#{delFlag},</if>
            <if test="createBy != null  and createBy != ''">#{createBy},</if>
            <if test="createTime != null ">#{createTime},</if>
            <if test="updateBy != null  and updateBy != ''">#{updateBy},</if>
            <if test="updateTime != null ">#{updateTime},</if>
         </trim>
    </insert>

    <update id="updateBizQuotation" parameterType="BizQuotation">
        update biz_quotation
        <trim prefix="SET" suffixOverrides=",">
            <if test="productId != null ">product_id = #{productId},</if>
            <if test="productRef1Id != null ">product_ref1_id = #{productRef1Id},</if>
            <if test="productRef1Num != null  and productRef1Num != ''">product_ref1_num = #{productRef1Num},</if>
            <if test="productRef2Id != null ">product_ref2_id = #{productRef2Id},</if>
            <if test="productRef2Num != null  and productRef2Num != ''">product_ref2_num = #{productRef2Num},</if>
            <if test="actuatorId != null ">actuator_id = #{actuatorId},</if>
            <if test="specialExpenses != null  and specialExpenses != ''">special_expenses = #{specialExpenses},</if>
            <if test="paymentMethod != null  and paymentMethod != ''">payment_method = #{paymentMethod},</if>
            <if test="freight != null ">freight = #{freight},</if>
            <if test="leadTime != null  and leadTime != ''">lead_time = #{leadTime},</if>
            <if test="reportProject != null  and reportProject != ''">report_project = #{reportProject},</if>
            <if test="normalFlag != null  and normalFlag != ''">normal_flag = #{normalFlag},</if>
            <if test="flowStatus != null  and flowStatus != ''">flow_status = #{flowStatus},</if>
            <if test="remark != null  and remark != ''">remark = #{remark},</if>
            <if test="string1 != null  and string1 != ''">string1 = #{string1},</if>
            <if test="string2 != null  and string2 != ''">string2 = #{string2},</if>
            <if test="string3 != null  and string3 != ''">string3 = #{string3},</if>
            <if test="string4 != null  and string4 != ''">string4 = #{string4},</if>
            <if test="string5 != null  and string5 != ''">string5 = #{string5},</if>
            <if test="string6 != null  and string6 != ''">string6 = #{string6},</if>
            <if test="string7 != null  and string7 != ''">string7 = #{string7},</if>
            <if test="string8 != null  and string8 != ''">string8 = #{string8},</if>
            <if test="string9 != null  and string9 != ''">string9 = #{string9},</if>
            <if test="string10 != null  and string10 != ''">string10 = #{string10},</if>
            <if test="status != null  and status != ''">status = #{status},</if>
            <if test="delFlag != null  and delFlag != ''">del_flag = #{delFlag},</if>
            <if test="createBy != null  and createBy != ''">create_by = #{createBy},</if>
            <if test="createTime != null ">create_time = #{createTime},</if>
            <if test="updateBy != null  and updateBy != ''">update_by = #{updateBy},</if>
            <if test="updateTime != null ">update_time = #{updateTime},</if>
        </trim>
        where quotation_id = #{quotationId}
    </update>

    <delete id="deleteBizQuotationById" parameterType="Long">
        delete from biz_quotation where quotation_id = #{quotationId}
    </delete>

    <delete id="deleteBizQuotationByIds" parameterType="String">
        delete from biz_quotation where quotation_id in 
        <foreach item="quotationId" collection="array" open="(" separator="," close=")">
            #{quotationId}
        </foreach>
    </delete>
    
</mapper>